<script> 
    Vue.component('EditableBlock', {
      props: ['vals', 'label'],
      name: 'EditableBlock',
      template: '#editable-block',
      data: function () {
        return {
          vals_: Object.values(this.vals),
          keys_: Object.keys(this.vals),
          dialog: false,
        }
      },
      methods: {
        saved: function() {
            for (var i = 0; i < this.keys_.length; i++){
                var [k, v] = [this.keys_[i], this.vals_[i]]
                if (typeof(v) === 'string' && v.split(',').length > 1){
                    this.vals[k] = v.split(',')
                } else {
                    this.vals[k] = v
                }
            }
        },
        closed: function() {
            this.dialog = false
        },
        indexof: function(k){
            return this.keys_.indexOf(k)
        },
        capitalize: function(input,len){
            if (typeof input === 'string'){
                var start = input.slice(0,len).toUpperCase()
                var out = input.replace("_", " ")
                return (input.slice(0,len).toUpperCase() + input.replace("_", " ").slice(len))
            } else {
                return input
            }
        },
        _key: function(k){
            return this.$vnode.key + '.' + k
        }
      },
      watch: {
        dialog: function() {
            var i = 0
            for (const [k, v] of Object.entries(this.vals)){
                if (['languages'].includes(k)){
                    this.vals_[i] = v.toString()
                } else {
                    this.vals_[i] = v
                }
                i ++
            }
        },
      },
      computed: {
          hints: function() {
              return {
                'tree.server.bind.host': 'Server listening address',
                'tree.server.bind.port': 'Server listening port',
                'tree.server.url': 'Server hostname',
                'tree.server.mimetype': 'default: application/json; charset=UTF-8',
                'tree.server.encoding': 'default: UTF-8',
                'tree.server.languages': 'Server locale languages',
                'tree.server.cors': 'Cross origin request support',
                'tree.server.pretty_print': 'JSON pretty print',
                'tree.server.limit': 'Default # of items returned',
                'tree.server.templates.path': 'Path to HTML templates',
                'tree.server.templates.static': 'Path to static folder',
                'tree.server.map.url': 'Map URL',
                'tree.server.map.attribution': 'html-like map attribution',
                'tree.server.manager.name': 'Processes manager name',
                'tree.server.manager.connection': 'Connection to stored jobs',
                'tree.server.manager.output_dir': 'Output Directory',
                'tree.server.manager.ogc_schemas_location': 'JSON-LD Schema folder',

                'tree.logging.level': 'Server logging level',
                'tree.logging.logfile': 'Server logfile path',

                'tree.metadata.identification.keywords_type': 'Keyword type (ISO 19115)',
                'tree.metadata.identification.terms_of_service': 'Service licensing',
                'tree.metadata.identification.url': 'Provider URL',
                'tree.metadata.license.name': 'License name',
                'tree.metadata.license.url': 'License URL',
                'tree.metadata.provider.name': 'Organization Name',
                'tree.metadata.provider.url': 'Organization URL',
                'tree.metadata.contact.name': 'Contact Name',
                'tree.metadata.contact.address': 'Mailing Address',
                'tree.metadata.contact.city': '',
                'tree.metadata.contact.stateorprovince': 'Name of state or province',
                'tree.metadata.contact.postalcode': 'Zip or Postal Code',
                'tree.metadata.contact.country': 'Country',
                'tree.metadata.contact.phone': '+xx-xxx-xxx-xxxx',
                'tree.metadata.contact.fax': '+xx-xxx-xxx-xxxx',
                'tree.metadata.contact.email': 'Contact email',
                'tree.metadata.contact.url': 'Contact URL',
                'tree.metadata.contact.hours': 'Availible hours', 
                'tree.metadata.contact.instructions': 'Availibility instructions',
                'tree.metadata.contact.role': 'Point of contact', 
              }
          },
          opts: function() {
              return {
                'tree.server.limit': [5,10,25,50,100,250,500,1000],
                'tree.logging.level': ['NOTSET','DEBUG','INFO','WARNING','ERROR','CRITICAL'],
                'tree.metadata.identification.keywords_type': ['discipline','temporal','place','theme','stratum'],
              }
          },
          exclude: function() {
              return ['map','bind','templates','manager',
               'context','links','extents','providers','geometry','title','description','keywords']
          },
      },
    })
</script>
<script type="text/x-template" id="editable-block">
    <div class="editable-block">
        <v-row justify="center" >
            <v-dialog v-model="dialog" width="60%" height=70%>
                
                <template v-slot:activator="{ on, attrs }">
                    <v-btn fab small absolute block bottom outlined raised rounded v-bind="attrs" v-on="on">  
                     <v-icon>mdi-pencil</v-icon> Edit
                    </v-btn>
                </template>
                
                <v-card>
                    <v-toolbar>
                    <v-btn icon @click="closed"> <v-icon>mdi-close</v-icon> </v-btn>
                    <v-toolbar-title> <span v-html="label ">Edit</span> </v-toolbar-title>
                    <v-spacer></v-spacer>
                    <v-toolbar-items> <v-btn @click="saved">Save</v-btn> </v-toolbar-items>
                    </v-toolbar>

                    <v-container>
                        <v-row> 
                            <template v-for="(v,k) in vals">

                                <v-col v-if="typeof(v) === 'object' && exclude.includes(k)"
                                 cols="12">   
                                    <span v-html="capitalize(k,1)"></span>
                                    <gui-block :vals="v" :label="k" :key="_key(k)"></gui-block>
                                </v-col>

                                <v-col v-else-if="['encoding', 'languages', 'name', 'output_dir', 'position', 'city', 'stateorprovince', 'postalcode', 'country', 'phone', 'fax', 'email'].includes(k)"
                                 cols="12" sm="6" md="3">
                                    <v-textarea
                                        v-model="vals_[indexof(k)]" reverse no-resize rows="1" :label="capitalize(k,1)" :hint="hints[_key(k)]"
                                    ></v-textarea>
                                </v-col>

                                <v-col v-else-if="['host', 'port', 'mimetype', 'path', 'static', 'terms_of_service', 'connection', 'address'].includes(k)" 
                                cols="12" md="6">
                                    <v-textarea 
                                    v-model="vals_[indexof(k)]" reverse no-resize rows="1" :label="capitalize(k,1)" :hint="hints[_key(k)]"
                                    ></v-textarea>
                                </v-col>

                                <v-col v-else-if="['url', 'attribution', 'ogc_schemas_location'].includes(k)" 
                                 cols="12">
                                    <v-textarea 
                                    v-model="vals_[indexof(k)]" reverse no-resize rows="1" :label="capitalize(k, k !== 'attribution' ? 3 : 1)" :hint="hints[_key(k)]"
                                    ></v-textarea>
                                </v-col>

                                <v-col v-else-if="['cors', 'pretty_print'].includes(k)" 
                                cols="12" sm="6" md="3">
                                    <v-checkbox 
                                        v-model="vals_[indexof(k)]" color="success" :label="capitalize(k,1)" :hint="hints[_key(k)]" persistent-hint
                                    ></v-checkbox>
                                </v-col>

                                <v-col v-else-if="['limit', 'level'].includes(k)" 
                                cols="12" md="6">
                                    <v-combobox 
                                        v-model="vals_[indexof(k)]" :items="opts[_key(k)]" :label="capitalize(k,1)" :hint="hints[_key(k)]" auto-select-first reverse persistent-hint
                                    ></v-combobox>
                                </v-col>   

                                <v-col v-else-if="['keywords_type'].includes(k)" 
                                 cols="12" md="6">
                                    <v-autocomplete 
                                        v-model="vals_[indexof(k)]" :items="opts[_key(k)]"  :label="capitalize(k,1)" :hint="hints[_key(k)]" auto-select-first reverse persistent-hint
                                    ></v-autocomplete>
                                </v-col>

                                <v-col v-else-if="k === 'type'" 
                                 cols="12" md="6">
                                    <v-autocomplete 
                                        v-if="$vnode.key.includes('provider')"
                                        v-model="vals_[indexof(k)]" :items="['feature', 'coverage', 'record', 'tile', 'edr']" auto-select-first reverse hint="Data Type" persistent-hint
                                    ></v-autocomplete>
                                    <v-textarea 
                                        v-else-if="$vnode.key.includes('links')"
                                        v-model="vals_[indexof(k)]" reverse no-resize rows="1" label="Mimetype"
                                    ></v-textarea>
                                    <v-autocomplete 
                                        v-else
                                        v-model="vals_[indexof(k)]" :items="['collection', 'process', 'stac-collection']" auto-select-first reverse hint="Type" persistent-hint
                                    ></v-autocomplete>
                                </v-col>

                                <v-col v-else-if="_key(k).includes('title') || _key(k).includes('description') || _key(k).includes('keywords')"
                                 cols="12" md="6">
                                    <v-textarea
                                        v-model.trim="vals_[indexof(k)]" reverse no-resize rows="1" :label="capitalize(k,1)"
                                    ></v-textarea>
                                </v-col>

                                <v-col v-else cols="12" md="6">
                                    <v-textarea 
                                         no-resize rows="2" :value="v" :label="k"
                                    ></v-textarea>
                                </v-col>
                            </template>
                        </v-row> 
                    </v-container>
                </v-card>
            </v-dialog>
        </v-row>
    </div>
</script>