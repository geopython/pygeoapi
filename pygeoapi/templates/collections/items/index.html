{% extends "_base.html" %}
{% block extrahead %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster-src.js"></script>
{% endblock %}

{% block body_map %}

  <div class="row">
    <div id="items-map" style="min-height: 600px;"></div>
  </div>

{% endblock %}

{% block body %}

  <section id="collection">
    <div class="row">
      <p>{{ data['missing_url'] }} <a href = "{{ data['missing_url_href'] }}/">{{ data['missing_url_href'] }}</a></p>
    </div>


    <div class="row">
      <p> </p>
    </div>
    <div class="row">
      <p>{% trans %}If Speckle model location data is available, the relevant URL parameters will be ignored. If neither model nor URL parameters specify the location, model will be placed randomly. {% endtrans %}</p>
    
      <p>{% trans %}Available Model Coordinate Reference System:  {% endtrans %} {{ data['model_crs'] }}</p>
    </div>

    
  </section>
  <section id="items">
    {% if data['features'] %}
    
    <div class="row">
      <p> </p>
    </div>

    <div class="row"></div>
    
    <div class="row">
      <div style="overflow-x: scroll;">
        <table class="table table-bordered">

          <thead>

            <tr>
              <th scope="column">URL parameters</th>
              <th></th>
            </tr>

          </thead>
          <tbody>

              <tr>
                <td >Speckle URL ('speckleurl')</td>
                  <td>
                    <a href="{{ data['speckle_url'] }}">
                      {{ data['speckle_url'] }}
                    </a>
                </td>
              </tr>
              <tr>
                <td >Coordinate Reference System ID ('crsauthid')</td>
                <td>{{ data['crs_authid'] }}</td>
              </tr>
              <tr>
                <td>Latitide ('lat')</td>
                <td>{{ data['lat'] }}</td>
              </tr>
              <tr>
                <td>Longitude ('lon')</td>
                <td>{{ data['lon'] }}</td>
              </tr>
              <tr>
                <td >Angle to True North, in degrees ('northdegrees')</td>
                <td>{{ data['north_degrees'] }}</td>
              </tr>
              <tr>
                <td >Feature limit ('limit')</td>
                <td>{{ data['limit'] }}</td>
              </tr>

          </tbody>
          </table>
      </div>
    </div>
    
    <div class="row">
      <p> </p>
    </div>
    

    <div class="row">
      <div style="overflow-x: scroll;">
        {% set props = [] %}
        <table class="table table-striped table-bordered">
          <thead>
            <tr>
              {% if data.get('uri_field') %}
                {% set uri_field = data.uri_field %}
                <th>{{ uri_field }}</th>
              {% elif data.get('title_field') %}
                {% set title_field = data.title_field %}
                <th>{{ title_field }}</th>
              {% else %}
                <th>id</th>
              {% endif %}

              {% for k in data['features'][0]['properties'].keys() %}
                {% if k not in [data.id_field, data.title_field, data.uri_field, 'extent'] %}
                  {% set props = props.append(k) %}
                  <th>{{ k | striptags }}</th>
                {% endif %}
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for ft in data.features %}
              <tr>
                {% if data.get('uri_field') %}
                  {% set uri_field = data.uri_field %}
                  <td data-label="{{ uri_field }}">
                    <a title="{{ ft.properties.get(uri_field) }}">
                      {{ ft.properties.get(uri_field) }}
                    </a>
                  </td>
                {% elif data.get('title_field') %}
                  {% set title_field = data.title_field %}
                  <td data-label="{{ title_field }}">
                    <a title="{{ ft.properties.get(title_field) }}" href="{{ data['speckle_project_url'] }}/models/{{ft.id}}">
                      {{ ft.properties.get(title_field) | string | truncate( 35 ) }}
                    </a>
                  </td>
                {% else %}
                  <td data-label="id">
                    <a title="{{ ft.id }}">
                      {{ ft.id | string | truncate( 12 )  }}
                    </a>
                  </td>
                {% endif %}

                {% for prop in props %}
                  <td data-label="{{ prop }}">
                    {{ ft.properties.get(prop, '') | string | truncate( 35 ) }}
                  </td>
                {% endfor %}

              </tr>
            {% endfor %}
          </tbody>
          </table>
      </div>
    </div>
    {% else %}
    <div class="row">
        <p>{% trans %}No items{% endtrans %}</p>
    </div>
    {% endif %}
    </section>
{% endblock %}

{% block extrafoot %}
{% if data['features'] %}
    <script>
    var map = L.map('items-map').setView([{{ 45 }}, {{ -75 }}], 5);
    map.addLayer(new L.TileLayer(
        '{{ config['server']['map']['url'] }}', {
            maxZoom: 24,
            attribution: '{{ config['server']['map']['attribution'] | safe }}'
        }
    ));

    var geojson_data = {{ data['features'] | to_json | safe }};

    var items = new L.GeoJSON(geojson_data, {
        // filter: (feature) => {
        //   return feature['geometry']['type'] != 'Point' && feature['geometry']['type'] != 'MultiPoint'
        // },
        pointToLayer: (feature, latlng) => {
            return new L.circleMarker(latlng)            
        },
        onEachFeature: function (feature, layer) {
            var url = '{{ data['speckle_project_url'] }}/models/' + feature.id
            var html = '<span><a href="' + url + '">' + {% if data['title_field'] %} feature['properties']['{{ data['title_field'] }}'] {% else %} feature.id {% endif %} + '</a></span>';
            layer.bindPopup(html);

            var myFillColor = feature.displayProperties['color'];
            var mylineWeight = feature.displayProperties['lineWidth'];
            var myRadius = feature.displayProperties['radius'];

            layer.setStyle({
                fillColor: myFillColor,
                color: myFillColor,
                fillOpacity: 0.8,
                weight: mylineWeight,
                radius: myRadius
            });
        }
    }); //.addTo(map);

    var group = L.featureGroup([items])
    .addTo(map);

    //map.addLayer(lines);

    map.fitBounds(group.getBounds());
    </script>
{% endif %}
{% endblock %}
